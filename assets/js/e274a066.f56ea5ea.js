"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[7488],{50248:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>i,contentTitle:()=>r,default:()=>p,frontMatter:()=>o,metadata:()=>l,toc:()=>s});var t=n(13274),c=n(79779);const o={slug:"zookeeper-java-use",title:"zookeeper\u7684Java\u5ba2\u6237\u7aef\u57fa\u672c\u4f7f\u7528",date:new Date("2024-04-02T00:00:00.000Z"),authors:"yuchengee",tags:["java","zookeeper","\u4e2d\u95f4\u4ef6","\u5206\u5e03\u5f0f"],keywords:["java","zookeeper","\u4e2d\u95f4\u4ef6","\u5206\u5e03\u5f0f"]},r=void 0,l={permalink:"/blog/zookeeper-java-use",editUrl:"https://github.com/yuchengee/blog/edit/master/blog/2024/04-02-zookeeper\u7684Java\u5ba2\u6237\u7aef.md",source:"@site/blog/2024/04-02-zookeeper\u7684Java\u5ba2\u6237\u7aef.md",title:"zookeeper\u7684Java\u5ba2\u6237\u7aef\u57fa\u672c\u4f7f\u7528",description:"Java\u4e2d\u5982\u4f55\u4f7f\u7528zookeeper\u3002",date:"2024-04-02T00:00:00.000Z",formattedDate:"2024\u5e744\u67082\u65e5",tags:[{label:"java",permalink:"/blog/tags/java"},{label:"zookeeper",permalink:"/blog/tags/zookeeper"},{label:"\u4e2d\u95f4\u4ef6",permalink:"/blog/tags/\u4e2d\u95f4\u4ef6"},{label:"\u5206\u5e03\u5f0f",permalink:"/blog/tags/\u5206\u5e03\u5f0f"}],readingTime:3.61,hasTruncateMarker:!0,authors:[{name:"yuchengee",title:"\u5e9f\u54c1\u5de5\u7a0b\u5e08",url:"https://github.com/yuchengee",imageURL:"/img/logo.png",key:"yuchengee"}],frontMatter:{slug:"zookeeper-java-use",title:"zookeeper\u7684Java\u5ba2\u6237\u7aef\u57fa\u672c\u4f7f\u7528",date:"2024-04-02T00:00:00.000Z",authors:"yuchengee",tags:["java","zookeeper","\u4e2d\u95f4\u4ef6","\u5206\u5e03\u5f0f"],keywords:["java","zookeeper","\u4e2d\u95f4\u4ef6","\u5206\u5e03\u5f0f"]},unlisted:!1,prevItem:{title:"SpringBoot\u6574\u5408Dubbo3.0\u57fa\u7840\u914d\u7f6eDemo",permalink:"/blog/springboot-dubbo-zk-demo"},nextItem:{title:"zookeeper\u7684\u57fa\u672c\u4f7f\u7528",permalink:"/blog/zookeeper-basic-use"}},i={authorsImageUrls:[void 0]},s=[{value:"\u57fa\u672c\u64cd\u4f5c",id:"\u57fa\u672c\u64cd\u4f5c",level:3},{value:"\u5206\u5e03\u5f0f\u9501",id:"\u5206\u5e03\u5f0f\u9501",level:3}];function d(e){const a={br:"br",code:"code",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,c.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(a.p,{children:"Java\u4e2d\u5982\u4f55\u4f7f\u7528zookeeper\u3002"}),"\n",(0,t.jsx)(a.p,{children:"Java\u53ef\u4ee5\u4f7f\u7528apache\u7684zk\u5ba2\u6237\u7aef\u5305\u6765\u4f7f\u7528zookeeper\uff0c\u4f7f\u7528apache curator\u7684zk\u5ba2\u6237\u7aef\u5305\u6765\u4f7f\u7528zookeeper\u5206\u5e03\u5f0f\u9501\u3002"}),"\n",(0,t.jsx)(a.h3,{id:"\u57fa\u672c\u64cd\u4f5c",children:"\u57fa\u672c\u64cd\u4f5c"}),"\n",(0,t.jsx)(a.p,{children:"apache.zookeeper \u7b80\u5355\u4f7f\u7528\uff0c\u5305\u542b\u67e5\u8be2\u3001\u521b\u5efa\u3001\u4fee\u6539\u3001\u5220\u9664\u3001\u76d1\u542c\u7b49\u57fa\u672c\u64cd\u4f5c\u7684\u4ee3\u7801\u3002"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-java",metastring:"title='MyWatcher' icon='logos:java'",children:'import org.apache.zookeeper.*;\nimport org.apache.zookeeper.data.Stat;\n\nimport java.nio.charset.StandardCharsets;\nimport java.util.List;\n\npublic class MyWatcher implements Watcher {\n    private ZooKeeper zooKeeper;\n    private final String path;\n    private volatile boolean keep;\n\n    public MyWatcher(String path, boolean keep) {\n        this.path = path;\n        this.keep = keep;\n    }\n\n    public void setZooKeeper(ZooKeeper zooKeeper) {\n        this.zooKeeper = zooKeeper;\n    }\n\n    public void stopKeep() {\n        this.keep = false;\n    }\n\n    @Override\n    public void process(WatchedEvent event) {\n        System.out.println("event:" + event);\n        if (keep) {\n            try {\n                zooKeeper.exists(path, this);\n            } catch (Exception e) {\n                throw new RuntimeException(e);\n            }\n        }\n    }\n\n    public static void main(String[] args) throws Exception {\n        String path = "/testwatch";\n        MyWatcher myWatcher = new MyWatcher(path, true);\n        ZooKeeper zooKeeper = new ZooKeeper("10.10.10.108:2181", 4000, myWatcher);\n        myWatcher.setZooKeeper(zooKeeper);\n\n        new Thread(() -> {\n            try {\n                Thread.sleep(3000);\n                // \u521b\u5efa\n                if (zooKeeper.exists(path, false) == null) {\n                    zooKeeper.create(path, "0".getBytes(StandardCharsets.UTF_8), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);\n                }\n\n                // \u67e5\u8be2\n                byte[] data = zooKeeper.getData(path, false, new Stat());\n                System.out.println(path + "\u5f53\u524dvalue:" + new String(data));\n\n                Thread.sleep(5000);\n                // \u4fee\u6539,version\u8868\u793a\u5f53\u524d\u7684dataVersion,-1\u8868\u793a\u4e0d\u68c0\u67e5\u7248\u672c\uff0c\u5fc5\u987b\u4e0ezk\u4e2d\u7684\u7248\u672c\u4e00\u81f4\u624d\u80fd\u4fee\u6539\u6210\u529f\u3002\n                zooKeeper.setData(path, "1".getBytes(StandardCharsets.UTF_8), -1);\n\n                Thread.sleep(5000);\n                // \u521b\u5efa\u5b57\u8282\u70b9\n                String childPath = path + "/test";\n                zooKeeper.create(childPath, "10".getBytes(StandardCharsets.UTF_8), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);\n                byte[] cdata = zooKeeper.getData(childPath, false, new Stat());\n                System.out.println(childPath + "\u5f53\u524dvalue:" + new String(cdata));\n                // \u67e5\u8be2\u5b50\u8282\u70b9\n                List<String> children = zooKeeper.getChildren(path, false);\n                System.out.println(children);\n\n                Thread.sleep(5000);\n                // \u5220\u9664\n                for (String child : children) {\n                    zooKeeper.delete(path + "/" + child, -1);\n                }\n                // \u6ca1\u6709deleteAll\uff0c\u53ea\u80fd\u5148\u5220\u9664\u6240\u6709\u7684\u5b50\u8282\u70b9\uff0c\u7136\u540e\u5728\u5220\u9664\u5f53\u524d\u8282\u70b9\u3002\n                zooKeeper.delete(path, -1);\n                myWatcher.stopKeep();// \u505c\u6b62\u76d1\u542c\n            } catch (Exception e) {\n                throw new RuntimeException(e);\n            }\n        }).start();\n        System.in.read();\n    }\n}\n\n'})}),"\n",(0,t.jsx)(a.h3,{id:"\u5206\u5e03\u5f0f\u9501",children:"\u5206\u5e03\u5f0f\u9501"}),"\n",(0,t.jsx)(a.p,{children:"\u6838\u5fc3\u601d\u60f3\uff1a\u5f53\u5ba2\u6237\u7aef\u8981\u83b7\u53d6\u9501\uff0c\u5219\u521b\u5efa\u8282\u70b9\uff0c\u4f7f\u7528\u5b8c\u9501\uff0c\u5219\u5220\u9664\u8be5\u8282\u70b9\u3002"}),"\n",(0,t.jsxs)(a.ol,{children:["\n",(0,t.jsxs)(a.li,{children:["\n",(0,t.jsx)(a.p,{children:"\u5ba2\u6237\u7aef\u83b7\u53d6\u9501\u65f6\uff0c\u5728lock\u8282\u70b9\u4e0b\u521b\u5efa\u4e34\u65f6\u987a\u5e8f\u8282\u70b9\u3002"}),"\n"]}),"\n",(0,t.jsxs)(a.li,{children:["\n",(0,t.jsx)(a.p,{children:"\u7136\u540e\u83b7\u53d6lock\u4e0b\u9762\u7684\u6240\u6709\u5b50\u8282\u70b9\uff0c\u5ba2\u6237\u7aef\u83b7\u53d6\u5230\u6240\u6709\u7684\u5b50\u8282\u70b9\u4e4b\u540e\uff0c\u5982\u679c\u53d1\u73b0\u81ea\u5df1\u521b\u5efa\u7684\u5b50\u8282\u70b9\u5e8f\u53f7\u6700\u5c0f\uff0c\u90a3\u4e48\u5c31\u8ba4\u4e3a\u8be5\u5ba2\u6237\u7aef\u83b7\u53d6\u5230\u4e86\u9501\u3002\u4f7f\u7528\u5b8c\u9501\u540e\uff0c\u5c06\u8be5\u8282\u70b9\u5220\u9664\u3002"}),"\n"]}),"\n",(0,t.jsxs)(a.li,{children:["\n",(0,t.jsx)(a.p,{children:"\u5982\u679c\u53d1\u73b0\u81ea\u5df1\u521b\u5efa\u7684\u8282\u70b9\u5e76\u975elock\u6240\u6709\u5b50\u8282\u70b9\u4e2d\u6700\u5c0f\u7684\uff0c\u8bf4\u660e\u81ea\u5df1\u8fd8\u6ca1\u6709\u83b7\u53d6\u5230\u9501\uff0c\u6b64\u65f6\u5ba2\u6237\u7aef\u9700\u8981\u627e\u5230\u6bd4\u81ea\u5df1\u5c0f\u7684\u90a3\u4e2a\u8282\u70b9\uff0c\u540c\u65f6\u5bf9\u5176\u6ce8\u518c\u4e8b\u4ef6\u76d1\u542c\u5668\uff0c\u76d1\u542c\u5220\u9664\u4e8b\u4ef6\u3002"}),"\n"]}),"\n",(0,t.jsxs)(a.li,{children:["\n",(0,t.jsx)(a.p,{children:"\u5982\u679c\u53d1\u73b0\u6bd4\u81ea\u5df1\u5c0f\u7684\u90a3\u4e2a\u8282\u70b9\u88ab\u5220\u9664\uff0c\u5219\u5ba2\u6237\u7aef\u7684 Watcher\u4f1a\u6536\u5230\u76f8\u5e94\u901a\u77e5\uff0c\u6b64\u65f6\u518d\u6b21\u5224\u65ad\u81ea\u5df1\u521b\u5efa\u7684\u8282\u70b9 \u662f\u5426\u662flock\u5b50\u8282\u70b9\u4e2d\u5e8f\u53f7\u6700\u5c0f\u7684\uff0c\u5982\u679c\u662f\u5219\u83b7\u53d6\u5230\u4e86\u9501\uff0c\u5982\u679c\u4e0d\u662f\u5219\u91cd\u590d\u4ee5\u4e0a\u6b65\u9aa4\u7ee7\u7eed\u83b7\u53d6\u5230\u6bd4\u81ea\u5df1\u5c0f\u7684\u4e00\u4e2a\u8282\u70b9\u5e76\u6ce8\u518c\u76d1\u542c\u3002"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(a.p,{children:(0,t.jsx)(a.strong,{children:"\u53ef\u91cd\u5165\u9501"})}),"\n",(0,t.jsxs)(a.ol,{children:["\n",(0,t.jsx)(a.li,{children:"\u9996\u5148\u6839\u636e\u5f53\u524d\u7ebf\u7a0b\u53bb\u67e5\u770b\u662f\u5426\u5b58\u5728\u9501\u6570\u636e\uff0c\u4e14\u5982\u679c\u6b64\u65f6\u8fd9\u4e2a\u7ebf\u7a0b\u6b63\u5728\u4f7f\u7528\u8fd9\u4e2a\u9501\uff0c\u5219\u6539\u53d8\u9501\u7684\u72b6\u6001\u6b21\u6570+1\uff0c\u5e76\u76f4\u63a5\u8fd4\u56detrue\u3002"}),"\n",(0,t.jsxs)(a.li,{children:["\u6ca1\u6709\u83b7\u53d6\u5230\u9501\u6570\u636e\u5219\u8fdb\u5165else",(0,t.jsx)(a.br,{}),"\n","\u5148\u53bb\u521b\u5efa\u9501\u6570\u636e\uff0c\u7136\u540e\u6392\u961f\u7b49\u5f85\u83b7\u53d6\u9501"]}),"\n",(0,t.jsx)(a.li,{children:"\u83b7\u53d6\u5230\u8fd4\u56detrue\uff0c\u5426\u5219false"}),"\n"]}),"\n",(0,t.jsxs)(a.p,{children:["InterProcessMutex\u5b9e\u73b0\u7684\u9501\u673a\u5236\u662f ",(0,t.jsx)(a.strong,{children:"\u516c\u5e73\u4e14\u4e92\u65a5"})," \u7684\uff0c\u516c\u5e73\u7684\u65b9\u5f0f\u662f\u6309\u7167\u6bcf\u4e2a\u8bf7\u6c42\u7684\u987a\u5e8f\u8fdb\u884c\u6392\u961f\u7684\u3002"]}),"\n",(0,t.jsx)(a.p,{children:"zk\u5206\u5e03\u5f0f\u9501\uff0c\u4ee3\u7801\u4e2d\u6a21\u62df50\u4e2a\u7ebf\u7a0b\u53bb\u6267\u884c\u9501\u7684\u62a2\u5360\uff0c\u62a2\u5230\u4e86\u5c31\u5bf9\u6a21\u62df\u8d44\u6e90\u8fdb\u884c\u64cd\u4f5c\u3002"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-java",metastring:"title='ZKLock' icon='logos:java'",children:'// \nimport org.apache.curator.framework.CuratorFramework;\nimport org.apache.curator.framework.CuratorFrameworkFactory;\nimport org.apache.curator.framework.recipes.locks.InterProcessMutex;\nimport org.apache.curator.retry.ExponentialBackoffRetry;\n\nimport java.nio.charset.StandardCharsets;\n\n/**\n * 1\u3001InterProcessMutex\uff1a\u5206\u5e03\u5f0f\u53ef\u91cd\u5165\u6392\u5b83\u9501\n * 2\u3001InterProcessSemaphoreMutex\uff1a\u5206\u5e03\u5f0f\u6392\u5b83\u9501\n * 3\u3001InterProcessReadWriteLock\uff1a\u5206\u5e03\u5f0f\u8bfb\u5199\u9501\n */\npublic class ZKLock {\n    private static volatile int soe = 0;\n\n    private static CuratorFramework getZkClient() {\n        String zkServerAddress = "10.10.10.108:2181";\n        ExponentialBackoffRetry retryPolicy = new ExponentialBackoffRetry(1000, 3, 5000);\n        CuratorFramework zkClient = CuratorFrameworkFactory.builder()\n                .connectString(zkServerAddress)\n                .sessionTimeoutMs(5000)\n                .connectionTimeoutMs(5000)\n                .retryPolicy(retryPolicy)\n                .build();\n        zkClient.start();\n        return zkClient;\n    }\n\n    public static void testLock() throws InterruptedException {\n        CuratorFramework zkClient = getZkClient();\n        String lockPath = "/lock";\n        String dataPath = "/data1";\n        InterProcessMutex lock = new InterProcessMutex(zkClient, lockPath);\n        //\u6a21\u62df50\u4e2a\u7ebf\u7a0b\u62a2\u9501\n        for (int i = 0; i < 50; i++) {\n            final int threadNo = i;\n            new Thread(() -> {\n                try {\n                    lock.acquire();\n                    soe++;\n                    System.out.println("\u7b2c" + threadNo + "\u7ebf\u7a0b\u83b7\u53d6\u5230\u4e86\u9501,\u5f53\u524d\u8d44\u6e90:" + soe);\n                    byte[] data1s = zkClient.getData().forPath(dataPath);\n                    int i1 = Integer.parseInt(new String(data1s)) + 1;\n                    zkClient.setData().forPath(dataPath, String.valueOf(i1).getBytes(StandardCharsets.UTF_8));\n                } catch (Exception e) {\n                    e.printStackTrace();\n                } finally {\n                    try {\n                        lock.release();\n                    } catch (Exception e) {\n                        e.printStackTrace();\n                    }\n                }\n            }).start();\n        }\n    }\n}\n\n'})}),"\n",(0,t.jsxs)(a.p,{children:["\u6267\u884c\u65f6\uff0c\u53ef\u4ee5\u67e5\u770bzk\u7684\u8282\u70b9\uff0c\u53d1\u73b0lock\u8282\u70b9\u4e0b\u6709\u5f88\u591a\u5b50\u7ed3\u70b9\uff0c\u7ed3\u5c3e\u662f\u6570\u5b57\u3002",(0,t.jsx)(a.br,{}),"\n",(0,t.jsx)(a.code,{children:"ls /lock"})]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{children:"[_c_0bd7db98-7293-4ebf-868c-644ed8a9d2cc-lock-0000000025, _c_0df4e4df-fb23-4a13-8e81-09bbc7a49810-lock-0000000029, _c_0ee81dd1-990d-4f0e-b447-bd2fd231180e-lock-0000000045, _c_0f98f7a3-5ba4-411a-a2fb-6f6b85dc7c42-lock-0000000034, _c_1419f252-9e91-453e-b1f4-185b839e17e4-lock-0000000039, _c_298da81b-938e-482d-a8a8-6be2baad23a1-lock-0000000026, _c_2db5d9ab-f80f-4906-98fb-da76832892e2-lock-0000000023, _c_400d0e0e-830f-4aa7-b977-cf7d206c9a0c-lock-0000000013, _c_4212d798-7447-4722-b7a1-2c8729b5a935-lock-0000000021, _c_44f6844a-8392-4958-b384-c03c14e73fc2-lock-0000000018, _c_4c20e129-d7e7-4717-98f2-8def8f4f81c0-lock-0000000032, _c_52196fa9-84ab-4058-9791-584b48c1766a-lock-0000000036, _c_557ab098-bc8e-452b-9f08-aaaab742bcbb-lock-0000000015, _c_686501a2-2119-46ae-b37d-64149ef9d328-lock-0000000033, _c_6e0656c2-7a18-4eb7-b978-b4bc9c5e5e9a-lock-0000000035, _c_72051f59-30b0-47fa-bea4-93d50e255b6a-lock-0000000042, _c_7463ce8e-ddc8-4634-81ea-1edd9c67d09a-lock-0000000048, _c_74828e3e-a403-49a9-979e-68cfca13b483-lock-0000000030, _c_76431b09-07ab-4fbf-891a-0ffeb1e3c620-lock-0000000007, _c_79733a94-c30f-43c0-88d2-25ce3da355d2-lock-0000000017, _c_7a5b19b7-3c2c-46d2-bfe9-e248076674e5-lock-0000000005, _c_7b5ebf62-ef21-4bd8-a39c-2fa7e60794c9-lock-0000000040, _c_7ed3e24e-33f7-4630-a6e8-5485c1a16c0f-lock-0000000031, _c_7fac0a53-7f68-4436-bfb3-b7a2e5116099-lock-0000000020, _c_901dd924-dbee-45f8-b482-2c73d6151dc1-lock-0000000014, _c_9e523745-1390-4028-a076-08ae9d7f830b-lock-0000000038, _c_a0e810bd-f5b4-49d9-a8b5-b82e47fde533-lock-0000000016, _c_a5cc6d4f-c74e-4bfc-b869-5be69dce2f4d-lock-0000000027, _c_a62bbac3-1d5c-4c72-b795-a1afe983a3ab-lock-0000000028, _c_a70a249f-c59c-4af0-b997-58240eb615da-lock-0000000010, _c_a93c7c02-1547-4556-a823-cff62dc1440f-lock-0000000041, _c_ad948f19-a549-40e3-b830-f054371b344f-lock-0000000047, _c_cce3c1fa-9d28-49e3-a783-0b072aac3c44-lock-0000000019, _c_cd4e129f-d45c-429d-8727-1fd8b94fac23-lock-0000000037, _c_cfdb66b3-0b40-4a04-8a42-79960f1ef398-lock-0000000012, _c_d121b78f-812c-49d9-8035-a856aaa4d933-lock-0000000006, _c_d2aac738-edfe-4ab9-8e5a-252e113b20a1-lock-0000000043, _c_d593721a-bfc3-4ef6-86a2-84d4c4484ba2-lock-0000000008, _c_da9dfacc-2ad0-40bd-b61a-a10ecf62e715-lock-0000000049, _c_dbfd9a99-d2e9-471f-b167-dd3067d7a1cc-lock-0000000046, _c_df7e74d7-2b7a-4bf7-a386-b48fd472a02f-lock-0000000044, _c_e3f65e06-70df-41a2-9a05-4cb60a5e7412-lock-0000000022, _c_e7d02737-2fd8-46e0-84ad-5ec41689cca1-lock-0000000024, _c_e9338bae-dacf-4570-aa7b-824cfec4b004-lock-0000000011, _c_f9f36d97-35d9-476c-8daf-46986790e431-lock-0000000009]\n"})})]})}function p(e={}){const{wrapper:a}={...(0,c.R)(),...e.components};return a?(0,t.jsx)(a,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},79779:(e,a,n)=>{n.d(a,{R:()=>r,x:()=>l});var t=n(79474);const c={},o=t.createContext(c);function r(e){const a=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(a):{...a,...e}}),[a,e])}function l(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:r(e.components),t.createElement(o.Provider,{value:a},e.children)}}}]);